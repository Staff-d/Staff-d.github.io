3:"$Sreact.fragment"
4:I[231,["411","static/chunks/411-9de8eb5daa65ab56.js","173","static/chunks/173-6cd06f1afb934c1c.js","376","static/chunks/376-dcd9863a661069d6.js","231","static/chunks/231-b6ed7b656f47d0fa.js","513","static/chunks/513-8b953d8c8e33f34f.js","333","static/chunks/app/posts/%5Bslug%5D/page-29208e190e48e383.js"],""]
5:I[39275,[],""]
6:I[61343,[],""]
7:I[25361,["411","static/chunks/411-9de8eb5daa65ab56.js","231","static/chunks/231-b6ed7b656f47d0fa.js","185","static/chunks/app/layout-92665f9ab19205d6.js"],"default",1]
9:I[53120,[],"OutletBoundary"]
b:I[53120,[],"MetadataBoundary"]
d:I[53120,[],"ViewportBoundary"]
f:I[76130,[],""]
1:HL["/_next/static/media/d4834662e8b5d3f9-s.p.ttf","font",{"crossOrigin":"","type":"font/ttf"}]
2:HL["/_next/static/css/ea6670b245d7b81f.css","style"]
0:{"P":null,"b":"IWR-JVBoX81026r8gJgkS","p":"","c":["","posts","minimal-lambda-containers-with-nix"],"i":false,"f":[[["",{"children":["posts",{"children":[["slug","minimal-lambda-containers-with-nix","d"],{"children":["__PAGE__?{\"slug\":\"minimal-lambda-containers-with-nix\"}",{}]}]}]},"$undefined","$undefined",true],["",["$","$3","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/ea6670b245d7b81f.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","className":"__variable_4eb141","children":["$","body",null,{"children":["$","div",null,{"className":"flex flex-col min-h-screen","children":[["$","header",null,{"className":"px-4 lg:px-6 h-14 flex items-center","children":[["$","$L4",null,{"className":"flex items-center justify-center","href":"/","children":[["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":24,"height":24,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-book-open h-6 w-6","children":[["$","path","1akyts",{"d":"M12 7v14"}],["$","path","ruj8y",{"d":"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"}],"$undefined"]}],["$","span",null,{"className":"sr-only","children":"Blog"}]]}],["$","nav",null,{"className":"ml-auto flex gap-4 sm:gap-6","children":[["$","$L4",null,{"className":"text-sm font-medium hover:underline underline-offset-4","href":"/","children":"Home"}],["$","$L4",null,{"className":"text-sm font-medium hover:underline underline-offset-4","href":"/contact","children":"Contact"}],["$","$L4",null,{"className":"text-sm font-medium hover:underline underline-offset-4","href":"/posts","children":"Blog"}]]}]]}],["$","$L5",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[]}],["$","$L7",null,{}],["$","footer",null,{"className":"flex flex-col gap-2 sm:flex-row py-6 w-full shrink-0 items-center px-4 md:px-6 border-t","children":[["$","p",null,{"className":"text-xs text-gray-500 dark:text-gray-400","children":["Â© ",2025," Sebastian Staffa."]}],["$","nav",null,{"className":"sm:ml-auto flex gap-4 sm:gap-6","children":[["$","$L4",null,{"className":"text-xs hover:underline underline-offset-4","href":"/feed.rss","prefetch":false,"children":"RSS"}],["$","$L4",null,{"className":"text-xs hover:underline underline-offset-4","href":"/imprint","children":"Imprint"}]]}]]}]]}]}]}]]}],{"children":["posts",["$","$3","c",{"children":[null,["$","$L5",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]]}],{"children":[["slug","minimal-lambda-containers-with-nix","d"],["$","$3","c",{"children":[null,["$","$L5",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children","$0:f:0:1:2:children:2:children:0","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L6",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]]}],{"children":["__PAGE__",["$","$3","c",{"children":["$L8",null,["$","$L9",null,{"children":"$La"}]]}],{},null]},null]},null]},null],["$","$3","h",{"children":[null,["$","$3","H30KT6wCk1DxoooNFh2UU",{"children":[["$","$Lb",null,{"children":"$Lc"}],["$","$Ld",null,{"children":"$Le"}],["$","meta",null,{"name":"next-size-adjust"}]]}]]}]]],"m":"$undefined","G":"$f","s":false,"S":true}
10:I[43421,["411","static/chunks/411-9de8eb5daa65ab56.js","173","static/chunks/173-6cd06f1afb934c1c.js","376","static/chunks/376-dcd9863a661069d6.js","231","static/chunks/231-b6ed7b656f47d0fa.js","513","static/chunks/513-8b953d8c8e33f34f.js","333","static/chunks/app/posts/%5Bslug%5D/page-29208e190e48e383.js"],"Avatar",1]
11:I[43421,["411","static/chunks/411-9de8eb5daa65ab56.js","173","static/chunks/173-6cd06f1afb934c1c.js","376","static/chunks/376-dcd9863a661069d6.js","231","static/chunks/231-b6ed7b656f47d0fa.js","513","static/chunks/513-8b953d8c8e33f34f.js","333","static/chunks/app/posts/%5Bslug%5D/page-29208e190e48e383.js"],"AvatarImage",1]
12:I[43421,["411","static/chunks/411-9de8eb5daa65ab56.js","173","static/chunks/173-6cd06f1afb934c1c.js","376","static/chunks/376-dcd9863a661069d6.js","231","static/chunks/231-b6ed7b656f47d0fa.js","513","static/chunks/513-8b953d8c8e33f34f.js","333","static/chunks/app/posts/%5Bslug%5D/page-29208e190e48e383.js"],"AvatarFallback",1]
13:I[38173,["411","static/chunks/411-9de8eb5daa65ab56.js","173","static/chunks/173-6cd06f1afb934c1c.js","376","static/chunks/376-dcd9863a661069d6.js","231","static/chunks/231-b6ed7b656f47d0fa.js","513","static/chunks/513-8b953d8c8e33f34f.js","333","static/chunks/app/posts/%5Bslug%5D/page-29208e190e48e383.js"],"Image"]
14:I[85025,["411","static/chunks/411-9de8eb5daa65ab56.js","173","static/chunks/173-6cd06f1afb934c1c.js","376","static/chunks/376-dcd9863a661069d6.js","231","static/chunks/231-b6ed7b656f47d0fa.js","513","static/chunks/513-8b953d8c8e33f34f.js","333","static/chunks/app/posts/%5Bslug%5D/page-29208e190e48e383.js"],"PreloadChunks"]
8:["$","main",null,{"className":"flex-1","children":[["$","script",null,{"type":"application/ld+json","suppressHydrationWarning":true,"dangerouslySetInnerHTML":{"__html":"{\"@context\":\"https://schema.org\",\"@type\":\"BlogPosting\",\"headline\":\"Improving Median Lambda Init Times By 23%\",\"datePublished\":\"2024-12-09T11:56:02.178Z\",\"dateModified\":\"2024-12-09T11:56:02.178Z\",\"description\":\"In today's post we are improving the cold start times of a Node.js Lambda function by building our own runtime image using Nix.\",\"image\":\"https://sebastian-staffa.eu/images/happy-whale-header.webp\",\"url\":\"https://sebastian-staffa.eu/posts/minimal-lambda-containers-with-nix\",\"author\":{\"@type\":\"Person\",\"name\":\"Sebastian Staffa\"}}"}}],["$","article",null,{"className":"container max-w-3xl px-4 py-6 lg:py-12 mx-auto","children":[["$","h1",null,{"className":"text-3xl font-bold tracking-tighter sm:text-4xl md:text-5xl lg:text-6xl/none mb-4","children":"Improving Median Lambda Init Times By 23%"}],"$undefined",["$","div",null,{"className":"flex items-center space-x-4 mb-4","children":[["$","$L10",null,{"children":[["$","$L11",null,{"src":"/_next/static/media/portrait-ico.778fd454.webp","alt":"Avatar of Sebastian Staffa"}],["$","$L12",null,{"children":"S"}]]}],["$","div",null,{"children":[["$","p",null,{"className":"text-sm font-medium","children":"Sebastian Staffa"}],["$","p",null,{"className":"text-sm text-gray-500 flex flex-row align-baseline","children":[["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":24,"height":24,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-calendar inline-block w-4 h-4 mr-1","children":[["$","path","1cmpym",{"d":"M8 2v4"}],["$","path","4m81vk",{"d":"M16 2v4"}],["$","rect","1hopcy",{"width":"18","height":"18","x":"3","y":"4","rx":"2"}],["$","path","8toen8",{"d":"M3 10h18"}],"$undefined"]}],"Published on"," ","Dec 9, 2024, 12:56 PM"]}]]}]]}],["$","$L13",null,{"src":{"src":"/_next/static/media/happy-whale-header.6c50a487.webp","height":1024,"width":2048,"blurDataURL":"data:image/webp;base64,UklGRkwAAABXRUJQVlA4IEAAAADQAQCdASoIAAQAAkA4JbACdAD0l8NQwAD+ayIqWaCQv2M5dMnzCvlPYQKarUlb94/oWfaTH8/lJfFMmwo8AAAA","blurWidth":8,"blurHeight":4},"alt":"An illustration of a whale breaking through clouds, generated by GPT-4o.","className":"rounded-lg object-cover w-full mb-8","priority":true}],["$","div",null,{"className":"prose max-w-none","children":[["$","$L14",null,{"moduleIds":"$undefined"}],"$L15"]}]]}],"$L16"]}]
17:I[70767,["411","static/chunks/411-9de8eb5daa65ab56.js","173","static/chunks/173-6cd06f1afb934c1c.js","376","static/chunks/376-dcd9863a661069d6.js","231","static/chunks/231-b6ed7b656f47d0fa.js","513","static/chunks/513-8b953d8c8e33f34f.js","333","static/chunks/app/posts/%5Bslug%5D/page-29208e190e48e383.js"],"default",1]
15:[["$","p",null,{"children":"One of the most powerful features of the nix package manager is the ability to\nmodify the build of each and every piece of software with ease - you don't need\nto, but you can. This is especially useful whenever we want to customize a tool\nor library for our use case or to optimize it for a specific environment."}],"\n",["$","p",null,{"children":"In this post, we will leverage the capabilities of nix to build a minimalistic\nDocker image for a Node.js lambda application, speed up the median cold start of\nthe lambda function by 23% percent and thus save money in the process."}],"\n",["$","p",null,{"children":[["$","strong",null,{"children":"This is a long blog post,"}]," click ",["$","a",null,{"href":"#results","children":"here"}]," if you are just interested\nin the results."]}],"\n",["$","h2",null,{"id":"the-idea","children":"The idea"}],"\n",["$","p",null,{"children":"I initially got the idea for this blog post when bundling an application for\nLambda for a customer of mine. To debug some permission issues I deployed an\nempty lambda function using a custom Docker image and noticed that the cold\nstart times were consistently in the mid-200ms range, which is quite a bit\nhigher than I would expect for a lambda function that does nothing."}],"\n",["$","p",null,{"children":["Upon further investigation I noticed that the\n",["$","a",null,{"href":"https://gallery.ecr.aws/lambda/nodejs","children":"Node.js AWS lambda base image"}],", that I\nwas using to build my docker image which contained the function code, was\nalready scratching the 380MB mark unzipped / 115MB when compressed. As a cloud\nis nothing more than a bunch of computers I figured that the size of the image\nmight have an impact on the cold start, as the image needs to be downloaded and\nunpacked before the function can be executed."]}],"\n",["$","p",null,{"children":"To test my hypothesis, I set out to build the smallest image possible that still\nruns a function. In order to achieve that, I would need maximum control over\neverything that goes into the image - and what better tool to do that than nix?"}],"\n",["$","h2",null,{"id":"about-lambda-init-times","children":"About Lambda init times"}],"\n",["$","p",null,{"children":"For those that don't know: AWS Lambda is a serverless \"function as a service\",\nwhich, in simple terms, allows you to upload your code to the service which will\nhandle its execution for you without the need to manage actual VMs or machines."}],"\n",["$","p",null,{"children":["Whenever a new request is sent to a Lambda function, the service first checks if\nthere are any idle workers available to process it. If not, a new worker is\nstarted. The time it takes for this worker to be ready to process the request is\ncalled ",["$","code",null,{"children":"init time"}]," and actually consists of\n",["$","a",null,{"href":"https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtime-environment.html#runtimes-lifecycle","children":"multiple init phases"}],":\nextension, runtime and function init."]}],"\n",["$","p",null,{"children":"After a worker is done processing a request, it does not shut down instantly,\nbut is kept in a warm state, ready to accept the next request. In this case, no\nadditional init phase is needed. If the worker does not receive a new request\nwithin a certain timeframe it is shut down completely."}],"\n",["$","p",null,{"children":"In practice, you notice these init times most often whenever there is a spike in\nrequests and a lot of additional workers need to be started. If you are using\nlambda to serve HTTP requests, e.g. through an API Gateway, you may notice your\nsite becoming sluggish."}],"\n",["$","h2",null,{"id":"building-a-basic-node-image-using-dockertools","children":["Building a basic node image using ",["$","code",null,{"children":"dockerTools"}]]}],"\n",["$","p",null,{"children":["The nix build system provides its own way to build a docker image from any given\nnix expression with it's ",["$","code",null,{"children":"dockerTools"}]," suite of tools. We'll be using the\nvanilla ",["$","code",null,{"children":"dockerTools.buildImage"}]," function to build our minimal docker image."]}],"\n",["$","p",null,{"children":"If we want to run Node.js on a Lambda, we'll at least need the Node.js binary.\nThe derivation to create a Docker image that only contains Node.js 20 would look\nlike this:"}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],"pkgs ",["$","span",null,{"className":"token operator","children":"?"}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token operator","children":"<"}],"nixpkgs",["$","span",null,{"className":"token operator","children":">"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":":"}],"\n"]}],["$","span",null,{"className":"code-line","children":["pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"dockerTools",["$","span",null,{"className":"token punctuation","children":"."}],"buildImage ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"node-only-test\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  tag ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"latest\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["  copyToRoot ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"buildEnv ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"image-root\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    paths ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],"pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"nodejs_20",["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    pathsToLink ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"/bin\""}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  config ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    Cmd ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"/bin/node\""}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"We can assert that this derivation works as we would expect by running:"}],"\n",["$","pre",null,{"className":"language-shell","children":["$","code",null,{"className":"language-shell code-highlight","children":[["$","span",null,{"className":"code-line","children":["$$ ",["$","span",null,{"className":"token function","children":"docker"}]," load ",["$","span",null,{"className":"token parameter variable","children":"-i"}]," ",["$","span",null,{"className":"token variable","children":[["$","span",null,{"className":"token variable","children":"$$("}],"nix-build",["$","span",null,{"className":"token variable","children":")"}]]}],"\n"]}],["$","span",null,{"className":"code-line","children":["d03ef6a91078: Loading layer ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"=="}],["$","span",null,{"className":"token operator","children":"="}],["$","span",null,{"className":"token operator","children":">"}],["$","span",null,{"className":"token punctuation","children":"]"}],"  ",["$","span",null,{"className":"token number","children":"194"}],".7MB/194.7MB\n"]}],["$","span",null,{"className":"code-line","children":["$$ ",["$","span",null,{"className":"token function","children":"docker"}]," run ",["$","span",null,{"className":"token parameter variable","children":"-it"}]," node-only-test:latest\n"]}],["$","span",null,{"className":"code-line","children":"Welcome to Node.js v20.17.0.\n"}],["$","span",null,{"className":"code-line","children":["Type ",["$","span",null,{"className":"token string","children":"\".help\""}]," ",["$","span",null,{"className":"token keyword","children":"for"}]," ",["$","span",null,{"className":"token function","children":"more"}]," information.\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token operator","children":">"}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token punctuation","children":"]"}],"+",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token punctuation","children":"]"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token string","children":"''"}],"\n"]}]]}]}],"\n",["$","h2",null,{"id":"adding-a-handler","children":"Adding a handler"}],"\n",["$","p",null,{"children":["Now that we have got a working Node.js installation, we need some code to run.\nFor now, a simple ",["$","code",null,{"children":"console.log"}]," will suffice:"]}],"\n",["$","pre",null,{"className":"language-js","children":["$","code",null,{"className":"language-js code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token string","children":"\"use strict\""}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token console class-name","children":"console"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token method function property-access","children":"log"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"hello world\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":["To get our ",["$","code",null,{"children":"handler.js"}]," into our image, we need to create a new derivation. As\nwe don't need to bundle/build our JavaScript app right now, we can just copy the\nfile to the nix store as is:"]}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],"pkgs ",["$","span",null,{"className":"token operator","children":"?"}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token operator","children":"<"}],"nixpkgs",["$","span",null,{"className":"token operator","children":">"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":":"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"let"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  fs ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"lib",["$","span",null,{"className":"token punctuation","children":"."}],"fileset",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"in"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"stdenv",["$","span",null,{"className":"token punctuation","children":"."}],"mkDerivation ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"example-aws-lambda-handler\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    src ",["$","span",null,{"className":"token operator","children":"="}]," fs",["$","span",null,{"className":"token punctuation","children":"."}],"toSource ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      root ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token url","children":"./."}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      fileset ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token url","children":"./handler.js"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    postInstall ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"''\n"}]]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"      mkdir -p $out/lib\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"      cp -v handler.js $out/lib\n"}]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token string","children":"    ''"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}]]}]}],"\n",["$","p",null,{"children":"Next, we need to update our existing image derivation to include our handler and\nchange the Docker command to run it:"}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],"pkgs ",["$","span",null,{"className":"token operator","children":"?"}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token operator","children":"<"}],"nixpkgs",["$","span",null,{"className":"token operator","children":">"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":":"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"let"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  handler ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./handler.nix"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],["$","span",null,{"className":"token keyword","children":"inherit"}]," pkgs",["$","span",null,{"className":"token punctuation","children":";"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"in"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"dockerTools",["$","span",null,{"className":"token punctuation","children":"."}],"buildImage ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"node-plus-handler-test\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    tag ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"latest\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["    copyToRoot ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"buildEnv ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"image-root\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      paths ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],"pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"nodejs_20 handler",["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      pathsToLink ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"/bin\""}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    config ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      Cmd ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"/bin/node\""}]," ",["$","span",null,{"className":"token string","children":["\"",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"handler",["$","span",null,{"className":"token punctuation","children":"}"}]]}],"/lib/handler.js\""]}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"Again, we can validate that our image works by loading and running it:"}],"\n",["$","pre",null,{"className":"language-shell","children":["$","code",null,{"className":"language-shell code-highlight","children":[["$","span",null,{"className":"code-line","children":["$$ ",["$","span",null,{"className":"token function","children":"docker"}]," load ",["$","span",null,{"className":"token parameter variable","children":"-i"}]," ",["$","span",null,{"className":"token variable","children":[["$","span",null,{"className":"token variable","children":"$$("}],"nix-build",["$","span",null,{"className":"token variable","children":")"}]]}],"\n"]}],["$","span",null,{"className":"code-line","children":["$$ ",["$","span",null,{"className":"token function","children":"docker"}]," run ",["$","span",null,{"className":"token parameter variable","children":"-it"}]," node-plus-handler-test:latest\n"]}],["$","span",null,{"className":"code-line","children":"hello world\n"}]]}]}],"\n",["$","h2",null,{"id":"building-the-aws-lambda-ric","children":"Building the AWS Lambda Ric"}],"\n",["$","p",null,{"children":["Until now, our image would not work in a Lambda environment, as we need one\nadditional component: The\n",["$","a",null,{"href":"https://www.npmjs.com/package/aws-lambda-ric/v/3.2.1","children":"AWS Lambda Runtime Interface Client"}],"\nor RIC for short. This library manages the communication between the Lambda\nservice and our application code that is deployed with the function. It accepts\nincoming events, calls the handler code, and passes the response back to Lambda."]}],"\n",["$","p",null,{"children":["There are a few different RICs for different languages, but we'll use the native\nNode.js RIC in this example. This library is available on npm and not yet part\nof the nixpkgs repository, so we'll need to package it ourselves. Nix already\nprovides a builder for packages from npm, called ",["$","code",null,{"children":"buildNpmPackage"}],", which we can\nuse to build the RIC package. As the RIC has a few native dependencies, and\nrequires building the\n",["$","a",null,{"href":"https://github.com/awslabs/aws-lambda-cpp","children":["$","code",null,{"children":"aws-lambda-cpp"}]}]," library using\n",["$","code",null,{"children":"node-gyp"}],", we'll need to add a few additional ",["$","code",null,{"children":"nativeBuildInputs"}]," to our\nderivation. Not all of them are documented in the ",["$","code",null,{"children":"aws-lambda-cpp"}]," README, so\nthe following derivation required a bit of trial and error to get right:"]}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  buildNpmPackage",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  fetchFromGitHub",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  nodejs",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  gcc",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  libgnurl",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  autoconf271",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  automake",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  cmake",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  libtool",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  perl",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":":"}],"\n"]}],["$","span",null,{"className":"code-line","children":["buildNpmPackage rec ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  pname ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"aws-lambda-nodejs-runtime-interface-client\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  version ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"3.2.1\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["  src ",["$","span",null,{"className":"token operator","children":"="}]," fetchFromGitHub ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    owner ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"aws\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    repo ",["$","span",null,{"className":"token operator","children":"="}]," pname",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    rev ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":["\"v",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"version",["$","span",null,{"className":"token punctuation","children":"}"}]]}],"\""]}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    hash ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"sha256-5NfhSavcrBlGZ4UYXRqPTXhB3FO0DhRq/2dg15D6tFc=\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token keyword","children":"inherit"}]," nodejs",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  npmDepsHash ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"sha256-XyHystDd+oxwhuNr5jpcqeVdMoEMUiSkvNF9P0M29Hs=\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  nativeBuildInputs ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],"autoconf271 automake cmake libtool perl",["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  buildInputs ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],"gcc libgnurl",["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["  dontUseCmakeConfigure ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token boolean","children":"true"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":["Now that we have a working runtime interface, we need to update our ",["$","code",null,{"children":"handler.js"}],"\nto conform to the\n",["$","a",null,{"href":"https://docs.aws.amazon.com/lambda/latest/dg/nodejs-handler.html","children":"requirements"}],"\nof Lambda:"]}],"\n",["$","pre",null,{"className":"language-js","children":["$","code",null,{"className":"language-js code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token string","children":"\"use strict\""}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["exports",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token method-variable function-variable method function property-access","children":"handler"}]," ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token keyword","children":"async"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token parameter","children":["event",["$","span",null,{"className":"token punctuation","children":","}]," context"]}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token arrow operator","children":"=>"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token keyword control-flow","children":"await"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"Promise"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token parameter","children":"resolve"}]," ",["$","span",null,{"className":"token arrow operator","children":"=>"}]," ",["$","span",null,{"className":"token function","children":"setTimeout"}],["$","span",null,{"className":"token punctuation","children":"("}],"resolve",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token number","children":"1000"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token comment","children":"// Simulate slow function"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token keyword control-flow","children":"return"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token literal-property property","children":"statusCode"}],["$","span",null,{"className":"token operator","children":":"}]," ",["$","span",null,{"className":"token number","children":"200"}],["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token literal-property property","children":"body"}],["$","span",null,{"className":"token operator","children":":"}]," ",["$","span",null,{"className":"token known-class-name class-name","children":"JSON"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token method function property-access","children":"stringify"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      ",["$","span",null,{"className":"token literal-property property","children":"message"}],["$","span",null,{"className":"token operator","children":":"}]," ",["$","span",null,{"className":"token string","children":"\"Hello World!\""}],["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["      ",["$","span",null,{"className":"token literal-property property","children":"streamName"}],["$","span",null,{"className":"token operator","children":":"}]," context",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token property-access","children":"logStreamName"}],["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["      ",["$","span",null,{"className":"token literal-property property","children":"now"}],["$","span",null,{"className":"token operator","children":":"}]," ",["$","span",null,{"className":"token keyword","children":"new"}]," ",["$","span",null,{"className":"token class-name","children":"Date"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token method function property-access","children":"toISOString"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"All that's left to do is to put the RIC into our image and change the Docker\ncommand to run it:"}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],"pkgs ",["$","span",null,{"className":"token operator","children":"?"}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./pinned-nixpkgs.nix"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":":"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"let"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  node ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"nodejs_20",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  lambdaRic ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token keyword","children":"with"}]," pkgs",["$","span",null,{"className":"token punctuation","children":";"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./aws-lambda-ric/aws-lambda-ric.nix"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    nodejs ",["$","span",null,{"className":"token operator","children":"="}]," node",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token keyword","children":"inherit"}]," buildNpmPackage fetchFromGitHub gcc libgnurl autoconf271 automake cmake libtool perl lib",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  handler ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./handler.nix"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],["$","span",null,{"className":"token keyword","children":"inherit"}]," pkgs",["$","span",null,{"className":"token punctuation","children":";"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"in"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"dockerTools",["$","span",null,{"className":"token punctuation","children":"."}],"buildImage ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"node-with-handler-and-ric\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    tag ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"latest\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["    copyToRoot ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"buildEnv ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"image-root\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      paths ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],"node lambdaRic handler",["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      pathsToLink ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"/bin\""}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["    config ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      Cmd ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"/bin/aws-lambda-ric\""}]," ",["$","span",null,{"className":"token string","children":["\"",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"handler",["$","span",null,{"className":"token punctuation","children":"}"}]]}],"/lib/handler.handler\""]}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"Let's validate that our image still works:"}],"\n",["$","pre",null,{"className":"language-shell","children":["$","code",null,{"className":"language-shell code-highlight","children":[["$","span",null,{"className":"code-line","children":["$$ ",["$","span",null,{"className":"token function","children":"docker"}]," load ",["$","span",null,{"className":"token parameter variable","children":"-i"}]," ",["$","span",null,{"className":"token variable","children":[["$","span",null,{"className":"token variable","children":"$$("}],"nix-build",["$","span",null,{"className":"token variable","children":")"}]]}],"\n"]}],["$","span",null,{"className":"code-line","children":["$$ ",["$","span",null,{"className":"token function","children":"docker"}]," run ",["$","span",null,{"className":"token parameter variable","children":"-it"}]," node-with-handler-and-ric:latest\n"]}],["$","span",null,{"className":"code-line","children":["Executing ",["$","span",null,{"className":"token string","children":"'/nix/store/p6gq8hm2gf36hsf7wyq7dhywpds08v92-example-aws-lambda-handler/lib/handler.handler'"}]," ",["$","span",null,{"className":"token keyword","children":"in"}]," ",["$","span",null,{"className":"token keyword","children":"function"}]," directory ",["$","span",null,{"className":"token string","children":"'/'"}],"\n"]}],["$","span",null,{"className":"code-line","children":["terminate called after throwing an instance of ",["$","span",null,{"className":"token string","children":"'std::logic_error'"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  what",["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],":  basic_string: construction from null is not valid\n"]}]]}]}],"\n",["$","p",null,{"children":["Yikes! Did we take a wrong turn somewhere? No, not really. The above error\nmessage is a bit misleading. The RIC is trying to connect to the Lambda services\nand fails to do so (as it is not running in a Lambda environment). To test our\nimage locally, we need the aptly named ",["$","code",null,{"children":"Lambda Runtime Interface Emulator"}]," or\n",["$","code",null,{"children":"Lambda RIE"}]," for short. Luckily, this tool is already available in the nixpkgs\nas ",["$","code",null,{"children":"aws-lambda-rie"}],"."]}],"\n",["$","p",null,{"children":["Adding this package to the build inputs of the image and changing the docker CMD\nto\n",["$","code",null,{"children":"Cmd = [\"aws-lambda-rie\" \"/bin/aws-lambda-ric\" \"${handler}/lib/handler.handler\"];"}],"\nallows us to run the image locally:"]}],"\n",["$","pre",null,{"className":"language-shell","children":["$","code",null,{"className":"language-shell code-highlight","children":[["$","span",null,{"className":"code-line","children":["$$ ",["$","span",null,{"className":"token function","children":"docker"}]," run ",["$","span",null,{"className":"token parameter variable","children":"-p"}]," ",["$","span",null,{"className":"token number","children":"8080"}],":8080 ",["$","span",null,{"className":"token parameter variable","children":"-it"}]," node-with-handler-and-ric:latest\n"]}],["$","span",null,{"className":"code-line","children":["$$ ",["$","span",null,{"className":"token function","children":"curl"}]," ",["$","span",null,{"className":"token string","children":"\"http://localhost:8080/2015-03-31/functions/function/invocations\""}]," ",["$","span",null,{"className":"token parameter variable","children":"-d"}]," ",["$","span",null,{"className":"token string","children":"'{}'"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],["$","span",null,{"className":"token string","children":"\"statusCode\""}],":200,",["$","span",null,{"className":"token string","children":"\"body\""}],["$","span",null,{"className":"token builtin class-name","children":":"}],["$","span",null,{"className":"token string","children":["\"{",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],"message",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],":",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],"Hello World!",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],",",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],"streamName",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],":",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],["$","span",null,{"className":"token variable","children":"$$LATEST"}],["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],",",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],"now",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],":",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],"2024-11-30T13:00:01.128Z",["$","span",null,{"className":"token entity","title":"\\\"","children":"\\\""}],"}\""]}],["$","span",null,{"className":"token punctuation","children":"}"}],"%\n"]}]]}]}],"\n",["$","p",null,{"children":"Note that later examples will omit the RIE package and assume that the image\nwill run in a Lambda environment."}],"\n",["$","h2",null,{"id":"shrinking-the-image","children":"Shrinking the image"}],"\n",["$","p",null,{"children":["Now that we have a working image that can run on AWS Lambda, it's time to take a\nlook at the size of our image. We'll be using\n",["$","a",null,{"href":"https://github.com/wagoodman/dive","children":["$","code",null,{"children":"dive"}]}]," to get a better grasp of the\ncontents of our image:"]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"code-highlight","children":[["$","span",null,{"className":"code-line","children":"â â Current Layer Contents â£ââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ\n"}],["$","span",null,{"className":"code-line","children":"Permission     UID:GID       Size  Filetree\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     310 MB  âââ nix\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     310 MB  â   âââ store\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     121 MB  â       âââ h723hb9m43lybmvfxkk6n7j4v664qy7b-python3-3.11.9\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      67 MB  â       âââ k5inwzpp6a0295pd3nfckk9hq8wmifhz-nodejs-20.15.1\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      40 MB  â       âââ 9as4j2wqvd88n6xf7bmwsb6n4riqjpww-icu4c-73.2\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      30 MB  â       âââ c10zhkbp6jmyh0xc5kd123ga8yy2p4hk-glibc-2.39-52\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      12 MB  â       âââ dsf31aa5l9lqpyk7cgnniwrinw7yzrbb-aws-lambda-nodejs-runtime-interface-client-3.2.1\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     9.1 MB  â       âââ swcl0ynnia5c57i6qfdcrqa72j7877mg-gcc-13.2.0-lib\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     6.5 MB  â       âââ 0d6qbqbgq8vl0nb3fy6wi9gfn6j3023d-openssl-3.0.14\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     5.6 MB  â       âââ 5lgw85a88a1bkwj0v3l367afrpyd4ac0-icu4c-73.2-dev\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     3.1 MB  â       âââ add5sh635jdzwsqn297fxhd13d5whxn0-ncurses-6.4\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     2.0 MB  â       âââ zdj2as83y9mcyv8xzhwgl2g8g1rr6mgn-openssl-3.0.14-dev\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     1.9 MB  â       âââ b7ipdvixma2jn8xv50kl2i55pb7ccb7q-tzdata-2024a\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     1.8 MB  â       âââ zvwpisszhpkkk8spqyya8n3bpm7wj39p-libunistring-1.1\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     1.6 MB  â       âââ 516kai7nl5dxr792c0nzq0jp8m4zvxpi-bash-5.2p32\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     1.5 MB  â       âââ mq90h9rv4yf8cz422ayy56fr4w8mi8fx-sqlite-3.45.3\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     1.4 MB  â       âââ mr63za5vkxj0yip6wj3j9lya2frdm3zc-coreutils-9.5\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     1.0 MB  â       âââ axajb2j3y3flz5knwybwa87c8l1zmcm9-openssl-3.0.14-bin\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     811 kB  â       âââ 6g1aqhzy0h5bzj82warn9vky175cyhag-gdbm-1.23\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     809 kB  â       âââ g78jna1i5qhh8gqs4mr64648f0szqgw4-xz-5.4.7\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     757 kB  â       âââ 9w009i6vvmjqcahi779yfx7wmd11m9hj-gmp-with-cxx-6.3.0\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     469 kB  â       âââ wz24hvvjsgfvz1hp06awzdvsvq4mc6x2-readline-8.2p10\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     346 kB  â       âââ 9jivp79yv91fl1i6ayq2107a78q7k43i-libidn2-2.3.7\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     270 kB  â       âââ mgmr6imyh0smpqhccb31dlk3hmnacjpc-expat-2.6.3\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     248 kB  â       âââ arhy8i96l81wz3zrldiwcmiax2gc2w7s-libuv-1.48.0\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     216 kB  â       âââ nfi1g1zr5di6xkqjwxwk5kdingf17h3g-mpdecimal-4.0.0\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     159 kB  â       âââ 2y852kcvb7shrj8f3z8j22pa0iybcbgj-xgcc-13.2.0-libgcc\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     159 kB  â       âââ yfd49ay99aa1a0jg80jsvnxbyl61fsh6-gcc-13.2.0-libgcc\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     129 kB  â       âââ c4v5jw6cp68m9a7akr157lyxiwa3byjf-libxcrypt-4.4.36\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     127 kB  â       âââ pkl664rrz6vb95piixzfm7qy1yc2xzgc-zlib-1.3.1\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     122 kB  â       âââ 7px4n99mcmdzx8nygx59f28j8g7vj0kb-acl-2.3.2\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     114 kB  â       âââ 77i5izsm6i7fyzdb5h8w28rcpawwqj6q-zlib-1.3.1-dev\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     110 kB  â       âââ c3xdbjc25q27x68swhkx1mfyw6vf5pc8-mailcap-2.1.53\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0     107 kB  â       âââ qdr5aqn6v6035mpqxxzxk12i82j7g402-libuv-1.48.0-dev\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      85 kB  â       âââ dwkhspb2qz0pbkkxlr6ajgqi388phhwa-attr-2.5.2\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      79 kB  â       âââ zindpxb2vylx0nsh2jjyg2fhaiakf8d9-bzip2-1.0.8\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      72 kB  â       âââ 6rwkpxli14j08klbsiwn23jmp9r46dmi-libffi-3.4.6\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      365 B  â       âââ p6gq8hm2gf36hsf7wyq7dhywpds08v92-example-aws-lambda-handler\n"}]]}]}],"\n",["$","p",null,{"children":[["$","code",null,{"children":"Total Image size: 310 MB"}]," is quite a lot for a Lambda function and barely less\nthan the ",["$","code",null,{"children":"public.ecr.aws/lambda/nodejs:20.2024.11.06.17"}]," base image we set out\nto beat that weighs in at ",["$","code",null,{"children":"Total Image size: 378 M"}],"."]}],"\n",["$","p",null,{"children":["Where did we go wrong? It's time to take a closer look at how the packages that\nwe need are structured right now and what their dependencies are. To do this, we\ncan use the ",["$","code",null,{"children":"nix-store"}]," command to inspect the dependencies of a derivation. To\nbe able to get a better understanding of how this tree of dependencies looks, we\ncan use the ",["$","code",null,{"children":"--graph"}]," flag to generate a\n",["$","a",null,{"href":"https://graphviz.org/doc/info/lang.html","children":"dot"}]," file which we can render as an\nSVG:"]}],"\n",["$","pre",null,{"className":"language-shell","children":["$","code",null,{"className":"language-shell code-highlight","children":["$","span",null,{"className":"code-line","children":["nix-store ",["$","span",null,{"className":"token parameter variable","children":"-q"}]," ",["$","span",null,{"className":"token parameter variable","children":"--graph"}]," ",["$","span",null,{"className":"token string","children":["\"",["$","span",null,{"className":"token variable","children":[["$","span",null,{"className":"token variable","children":"$$("}],"nix-build node-with-handler-and-ric-container.nix",["$","span",null,{"className":"token variable","children":")"}]]}],"\""]}],["$","span",null,{"className":"token operator","children":"|"}]," dot ",["$","span",null,{"className":"token parameter variable","children":"-Tsvg"}],"\n"]}]}]}],"\n",["$","p",null,{"children":["If you are missing the dot executable in your path, you can use\n",["$","code",null,{"children":"nix-shell -p graphviz"}]," to get a temporary shell containing the graphviz\ntooling. The output of this command can be piped to a file and opened in any\nimage viewer or browser:"]}],"\n",["$","a",null,{"target":"_blank","href":"/_next/static/media/nix-store-node-with-handler-and-ric-container.d9b25168.svg","children":["$","$L13",null,{"src":{"src":"/_next/static/media/nix-store-node-with-handler-and-ric-container.d9b25168.svg","height":923,"width":2991,"blurWidth":0,"blurHeight":0},"alt":"tree of all node20 and lambda ric dependencies"}]}],"\n",["$","p",null,{"children":[["$","i",null,{"children":"Note"}],": If you want to reproduce this graph, you'll need to inspect the\noutput of the ",["$","code",null,{"children":"buildEnv"}]," builder. Inspecting the output of ",["$","code",null,{"children":"buildImage"}]," will\njust show a single node for the docker image, as all dependencies are flattened\ninto a self-contained single layer without any reference to the nix store on the\nbuild system."]}],"\n",["$","p",null,{"children":["Eureka! It looks like our ",["$","code",null,{"children":"aws-lambda-ric"}]," derivation is pulling python 3.11 as\na dependency. This package alone is about 120MB in size, as we can deduce from\nthe ",["$","code",null,{"children":"dive"}]," output. But why?"]}],"\n",["$","p",null,{"children":["The npm ",["$","code",null,{"children":"aws-lambda-ric"}]," package is pure JavaScript, but has\n",["$","a",null,{"href":"https://www.npmjs.com/package/aws-lambda-ric/v/3.2.1?activeTab=dependencies","children":"two dependencies"}],":\n",["$","code",null,{"children":"node-gyp"}]," and ",["$","code",null,{"children":"node-addon-api"}],". Both are only used to build the native ric\nbindings written in C++, but are still marked as runtime dependencies in the\n",["$","code",null,{"children":"package.json"}]," file. To determine runtime dependencies that need to be copied to\nthe final derivation as ",["$","code",null,{"children":"buildNpmPackage"}]," runs a ",["$","code",null,{"children":"npm install --omit=dev"}]," and\ncopies the resulting ",["$","code",null,{"children":"node_modules"}]," directory to the final derivation. As\n",["$","code",null,{"children":"node-gyp"}]," contains a few python scripts these are copied to the final\nderivation as well, which in turn pulls in python as a dependency."]}],"\n",["$","p",null,{"children":["As we know that these dependencies are not needed during runtime we can solve\nthis problem easily by removing the whole ",["$","code",null,{"children":"node_modules"}]," directory from the\nfinal derivation. This can be done by adding a ",["$","code",null,{"children":"postInstall"}]," hook:"]}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"# parameters omitted"}],"\n"]}],["$","span",null,{"className":"code-line","children":["buildNpmPackage rec ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token comment","children":"# ...rest of the derivation"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["  postInstall ",["$","span",null,{"className":"token operator","children":"="}]," lib",["$","span",null,{"className":"token punctuation","children":"."}],"optionalString prunePython ",["$","span",null,{"className":"token string","children":"''\n"}]]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    # All dependencies of the ric are not actual\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    # runtime deps, but are build deps. We can remove\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    # them to reduce the size of the final image.\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    rm -rf $nodeModulesPath\n"}]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token string","children":"  ''"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}]]}]}],"\n",["$","p",null,{"children":["But we are still not done here! While working through the ",["$","code",null,{"children":"node-gyp"}]," issue, I\nnoticed that source code of the ",["$","code",null,{"children":"aws-lambda-cpp"}]," library is bundled with the npm\npackage. There are also a few zip files of source code of its dependencies in a\ndirectory called ",["$","code",null,{"children":"deps"}],". While we are here, we can remove those as well. This\nleaves us with this final ",["$","code",null,{"children":"postInstall"}]," hook:"]}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"# parameters omitted"}],"\n"]}],["$","span",null,{"className":"code-line","children":["buildNpmPackage rec ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token comment","children":"# ...rest of the derivation"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["  postInstall ",["$","span",null,{"className":"token operator","children":"="}]," lib",["$","span",null,{"className":"token punctuation","children":"."}],"optionalString prunePython ",["$","span",null,{"className":"token string","children":"''\n"}]]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    # All dependencies of the ric are not actual\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    # runtime deps, but are build deps. We can remove\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    # them to reduce the size of the final image.\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    rm -rf $nodeModulesPath\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    # remove build leftovers\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"    find $out/lib/node_modules/aws-lambda-ric/deps -maxdepth 1 \\\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"        -not \\( -path $out/lib/node_modules/aws-lambda-ric/deps/artifacts -prune \\) \\\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"        -not \\( -name deps \\) \\\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"        -exec rm -rf {} \\;\n"}]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token string","children":"  ''"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":["Taking a look at our image right now we can see that we made a lot of progress,\nas it now stands at ",["$","code",null,{"children":"Total Image size: 168 MB"}],". But there is still more we can\ndo!"]}],"\n",["$","p",null,{"children":["Currently, we are using ",["$","code",null,{"children":"nodejs_20"}]," from the nixpkgs, which contains a full node\ninstallation including tools like ",["$","code",null,{"children":"npm"}]," and ",["$","code",null,{"children":"npx"}],", which we don't need if we\njust want to run a prebundled JavaScript app. Luckily, nixpkgs also contains a\n",["$","code",null,{"children":"slim"}]," package for every Node.js version. In our case this is ",["$","code",null,{"children":"nodejs-slim_20"}],"."]}],"\n",["$","p",null,{"children":["If our handler was the only JS code being added to the image, this package would\nbe a drop-in replacement for ",["$","code",null,{"children":"nodejs_20"}],", but we also need to build the\n",["$","code",null,{"children":"aws-lambda-ric"}]," package. To do so, we need the full Node.js installation.\nDuring build, the package generates a wrapper js executable. ",["$","code",null,{"children":"buildNpmPackage"}],"\npatches this executable to point to the Node.js installation used during the\nbuild. This in turn pulls the full Node.js installation into the final\nderivation:"]}],"\n",["$","pre",null,{"className":"language-shell","children":["$","code",null,{"className":"language-shell code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token shebang important","children":"#! /nix/store/syl4snn859kpqvn9qh91kr7n9i4dws04-bash-5.2p32/bin/bash -e"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token builtin class-name","children":"exec"}]," ",["$","span",null,{"className":"token string","children":"\"/nix/store/if6aqyl3sl0hz14a12mndj35swb1mcwi-nodejs-20.17.0/bin/node\""}],"  /nix/store/fv8d452b9hr0pf0w9bdc3ja7n0fb653r-aws-lambda-nodejs-runtime-interface-client-3.2.1/lib/node_modules/aws-lambda-ric/bin/index.mjs ",["$","span",null,{"className":"token string","children":["\"",["$","span",null,{"className":"token variable","children":"$$@"}],"\""]}],"\n"]}]]}]}],"\n",["$","p",null,{"children":["To fix this, we could either change the path in the ",["$","code",null,{"children":"aws-lambda-ric"}]," executable\nthat pulls the build Node.js version after it is built, or we could get rid of\nthe executable altogether by updating our Docker ",["$","code",null,{"children":"CMD"}]," line to include the node\ninvocation directly."]}],"\n",["$","p",null,{"children":["I've chosen to do the former by wrapping the ",["$","code",null,{"children":"aws-lambda-ric"}]," derivation into a\nnew derivation that fixes the shebang line by adding a ",["$","code",null,{"children":"postFixup"}]," hook:"]}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  pkgs",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  minifiedNode",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  buildNode",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":":"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"with"}]," pkgs",["$","span",null,{"className":"token punctuation","children":";"}]," ",["$","span",null,{"className":"token keyword","children":"let"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  lambdaRic ",["$","span",null,{"className":"token operator","children":"="}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./aws-lambda-ric/aws-lambda-ric.nix"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      nodejs ",["$","span",null,{"className":"token operator","children":"="}]," buildNode",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      ",["$","span",null,{"className":"token keyword","children":"inherit"}]," buildNpmPackage fetchFromGitHub gcc libgnurl autoconf271 automake cmake libtool perl lib",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"."}],"overrideAttrs ",["$","span",null,{"className":"token punctuation","children":"("}],"oldAttrs",["$","span",null,{"className":"token punctuation","children":":"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      postFixup ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"''\n"}]]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":["        escapedNewInterpeter=$(printf '%s\\n' \"",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"minifiedNode",["$","span",null,{"className":"token punctuation","children":"}"}]]}],"\" | sed -e 's/[\\/&]/\\\\&/g')\n"]}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":["        escapedOldInterpeter=$(printf '%s\\n' \"",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"buildNode",["$","span",null,{"className":"token punctuation","children":"}"}]]}],"\" | sed -e 's/[]\\/$*.^[]/\\\\&/g')\n"]}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"        find $out -type f -print0 | xargs -0 sed -i \"s/$escapedOldInterpeter/$escapedNewInterpeter/g\"\n"}]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token string","children":"      ''"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"in"}],"\n"]}],["$","span",null,{"className":"code-line","children":"  lambdaRic\n"}]]}]}],"\n",["$","p",null,{"children":["Using ",["$","code",null,{"children":"nodejs-slim"}]," pushes our Image down to ",["$","code",null,{"children":"Total Image size: 158 MB"}],"\naccording to dive. This is as far down as we can get without removing any of the\nfunctionality that Node.js offers."]}],"\n",["$","h2",null,{"id":"removing-intl-capabilities","children":"Removing intl capabilities"}],"\n",["$","p",null,{"children":["Usually, when I ship some kind of backend application, I don't need a lot of\nI18n support, as the frontend of my application takes care of that. Using this\nprecondition, we can safely remove all I18n capabilities from the node version\nthat we want to bundle. This allows us to get rid of the\n",["$","a",null,{"href":"https://nodejs.org/docs/latest-v20.x/api/intl.html","children":["$","code",null,{"children":"intl"}]}]," support from node,\nwhich removes the ",["$","code",null,{"children":"icu4c"}]," dependency which comes in at 40MB. We can also remove\nmost of the glibc locales which are another 16MB:"]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"code-highlight","children":[["$","span",null,{"className":"code-line","children":"...\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      40 MB  â       âââ 9as4j2wqvd88n6xf7bmwsb6n4riqjpww-icu4c-73.2\n"}],["$","span",null,{"className":"code-line","children":"...\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      30 MB          âââ c10zhkbp6jmyh0xc5kd123ga8yy2p4hk-glibc-2.39-5\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      16 MB          â   âââ share\n"}],["$","span",null,{"className":"code-line","children":"dr-xr-xr-x         0:0      16 MB          â       âââ i18n\n"}],["$","span",null,{"className":"code-line","children":"...\n"}]]}]}],"\n",["$","p",null,{"children":["Beyond the 40MB of ",["$","code",null,{"children":"icu4c"}]," itself, it also pulls a few additional dependencies:"]}],"\n",["$","a",null,{"target":"_blank","href":"/_next/static/media/nix-store-query-nodejs-slim20.9f5524fa.svg","children":["$","$L13",null,{"src":{"src":"/_next/static/media/nix-store-query-nodejs-slim20.9f5524fa.svg","height":731,"width":1476,"blurWidth":0,"blurHeight":0},"alt":"tree of all nodejs-slim_20 dependencies"}]}],"\n",["$","p",null,{"children":["To remove ",["$","code",null,{"children":"intl"}]," support, we need to\n",["$","a",null,{"href":"https://github.com/nodejs/node/blob/d5d1e80763202ffa73307213211148571deac27c/BUILDING.md#intl-ecma-402-support","children":["compile Node.js with the ",["$","code",null,{"children":"--without-intl"}]," flag"]}],".\nThe nixpkgs builder for Node.js adds the ",["$","code",null,{"children":"--with-intl=system-icu"}]," flag by\ndefault, so we need to remove this flag and add the ",["$","code",null,{"children":"--without-intl"}]," flag\ninstead. We'll do this by creating a new derivation that takes any Node.js\npackage and recompiles it without ",["$","code",null,{"children":"intl"}]," by changing the build flags. While we\nare here, we can also remove some additional stuff that we don't need during\nruntime like header files and man pages:"]}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  lib",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  nodeToMinify",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":":"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"let"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  minifiedNode ",["$","span",null,{"className":"token operator","children":"="}]," nodeToMinify",["$","span",null,{"className":"token punctuation","children":"."}],"overrideAttrs ",["$","span",null,{"className":"token punctuation","children":"("}],"oldAttrs",["$","span",null,{"className":"token punctuation","children":":"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    postInstall ",["$","span",null,{"className":"token operator","children":"="}],"\n"]}],["$","span",null,{"className":"code-line","children":["      oldAttrs",["$","span",null,{"className":"token punctuation","children":"."}],"postInstall\n"]}],["$","span",null,{"className":"code-line","children":["      ",["$","span",null,{"className":"token operator","children":"+"}]," ",["$","span",null,{"className":"token string","children":"''\n"}]]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"        rm -r $out/share\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"        rm -r $out/lib\n"}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":"        rm -r $out/include\n"}]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token string","children":"      ''"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["    configureFlags ",["$","span",null,{"className":"token operator","children":"="}],"\n"]}],["$","span",null,{"className":"code-line","children":["      ",["$","span",null,{"className":"token punctuation","children":"("}],"lib",["$","span",null,{"className":"token punctuation","children":"."}],"remove ",["$","span",null,{"className":"token string","children":"\"--with-intl=system-icu\""}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"lib",["$","span",null,{"className":"token punctuation","children":"."}],"flatten oldAttrs",["$","span",null,{"className":"token punctuation","children":"."}],"configureFlags",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      ",["$","span",null,{"className":"token operator","children":"++"}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"--without-intl\""}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"in"}],"\n"]}],["$","span",null,{"className":"code-line","children":"  minifiedNode\n"}]]}]}],"\n",["$","p",null,{"children":["For ",["$","code",null,{"children":"glibc"}]," we'll create a similar derivation that removes the locales and\ncharmaps that we don't need:"]}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  glibc",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  concatMapStringsSep",["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  localesToKeep ",["$","span",null,{"className":"token operator","children":"?"}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":["  charmapsToKeep ",["$","span",null,{"className":"token operator","children":"?"}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":","}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":":"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"let"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  glibCLocales ",["$","span",null,{"className":"token operator","children":"="}]," localesToKeep ",["$","span",null,{"className":"token operator","children":"++"}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"C\""}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  glibCCharmaps ",["$","span",null,{"className":"token operator","children":"="}]," charmapsToKeep ",["$","span",null,{"className":"token operator","children":"++"}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"UTF-8\""}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["  minGlibC ",["$","span",null,{"className":"token operator","children":"="}]," glibc",["$","span",null,{"className":"token punctuation","children":"."}],"overrideAttrs ",["$","span",null,{"className":"token punctuation","children":"("}],"oldAttrs",["$","span",null,{"className":"token punctuation","children":":"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    postInstall ",["$","span",null,{"className":"token operator","children":"="}],"\n"]}],["$","span",null,{"className":"code-line","children":["      oldAttrs",["$","span",null,{"className":"token punctuation","children":"."}],"postInstall\n"]}],["$","span",null,{"className":"code-line","children":["      ",["$","span",null,{"className":"token operator","children":"+"}]," ",["$","span",null,{"className":"token string","children":"''\n"}]]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":["        find $out/share/i18n/locales -type f ",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"concatMapStringsSep ",["$","span",null,{"className":"token string","children":"\" \""}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"l",["$","span",null,{"className":"token punctuation","children":":"}]," ",["$","span",null,{"className":"token string","children":["\"-not -name '",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"l",["$","span",null,{"className":"token punctuation","children":"}"}]]}],"'\""]}],["$","span",null,{"className":"token punctuation","children":")"}]," glibCLocales",["$","span",null,{"className":"token punctuation","children":"}"}]]}]," -exec rm {} \\;\n"]}]}],["$","span",null,{"className":"code-line","children":["$","span",null,{"className":"token string","children":["        find $out/share/i18n/charmaps -type f ",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"concatMapStringsSep ",["$","span",null,{"className":"token string","children":"\" \""}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"l",["$","span",null,{"className":"token punctuation","children":":"}]," ",["$","span",null,{"className":"token string","children":["\"-not -name '",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"l",["$","span",null,{"className":"token punctuation","children":"}"}]]}],".gz'\""]}],["$","span",null,{"className":"token punctuation","children":")"}]," glibCCharmaps",["$","span",null,{"className":"token punctuation","children":"}"}]]}]," -exec rm {} \\;\n"]}]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token string","children":"      ''"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"in"}],"\n"]}],["$","span",null,{"className":"code-line","children":"  minGlibC\n"}]]}]}],"\n",["$","p",null,{"children":["Now we just have to make sure that every package that gets put into the final\nDocker image uses this minified ",["$","code",null,{"children":"glibc"}]," to prevent the unmodified ",["$","code",null,{"children":"glibc"}]," from\nbeing pulled in as a dependency. The simplest way to do this is to define an\noverlay over the used nixpkgs that replaces the glibc package with the minified\nversion:"]}],"\n",["$","pre",null,{"className":"language-nix","children":["$","code",null,{"className":"language-nix code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"{"}],"pkgs ",["$","span",null,{"className":"token operator","children":"?"}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./pinned-nixpkgs.nix"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":":"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"let"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  glibcNoLocales ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./glibc-no-locales.nix"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    glibc ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"glibc",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    lib ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"lib",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  moddedPkgs ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"extend ",["$","span",null,{"className":"token punctuation","children":"("}],"self",["$","span",null,{"className":"token punctuation","children":":"}]," super",["$","span",null,{"className":"token punctuation","children":":"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"glibc ",["$","span",null,{"className":"token operator","children":"="}]," glibcNoLocales",["$","span",null,{"className":"token punctuation","children":";"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["  minifiedNode ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./minified-node.nix"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    lib ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"lib",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    nodeToMinify ",["$","span",null,{"className":"token operator","children":"="}]," moddedPkgs",["$","span",null,{"className":"token punctuation","children":"."}],"nodejs",["$","span",null,{"className":"token operator","children":"-"}],"slim_20",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  lambdaRic ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./lambda-ric-with-interpreter.nix"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    buildNode ",["$","span",null,{"className":"token operator","children":"="}]," moddedPkgs",["$","span",null,{"className":"token punctuation","children":"."}],"nodejs_20",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    pkgs ",["$","span",null,{"className":"token operator","children":"="}]," moddedPkgs",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token keyword","children":"inherit"}]," minifiedNode",["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["  handler ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token function","children":"import"}]," ",["$","span",null,{"className":"token url","children":"./handler.nix"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"pkgs ",["$","span",null,{"className":"token operator","children":"="}]," moddedPkgs",["$","span",null,{"className":"token punctuation","children":";"}],["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"in"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"dockerTools",["$","span",null,{"className":"token punctuation","children":"."}],"buildImage ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"nodetest\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    tag ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"latest\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["    copyToRoot ",["$","span",null,{"className":"token operator","children":"="}]," pkgs",["$","span",null,{"className":"token punctuation","children":"."}],"buildEnv ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      name ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token string","children":"\"image-root\""}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      paths ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],"lambdaRic handler",["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      pathsToLink ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"/bin\""}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["    config ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["      Cmd ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"["}],["$","span",null,{"className":"token string","children":"\"/bin/aws-lambda-ric\""}]," ",["$","span",null,{"className":"token string","children":["\"",["$","span",null,{"className":"token interpolation","children":[["$","span",null,{"className":"token antiquotation important","children":"$$"}],["$","span",null,{"className":"token punctuation","children":"{"}],"handler",["$","span",null,{"className":"token punctuation","children":"}"}]]}],"/lib/handler.handler\""]}],["$","span",null,{"className":"token punctuation","children":"]"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],["$","span",null,{"className":"token punctuation","children":";"}],"\n"]}],["$","span",null,{"className":"code-line","children":["  ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],"\n",["$","p",null,{"children":["This final image now only needs ",["$","code",null,{"children":"Total Image size: 93 M"}]," (or 31MB compressed),\nwhich is almost a 75 percent reduction in size compared to the AWS base image!"]}],"\n",["$","h2",null,{"id":"tests","children":"Tests"}],"\n",["$","p",null,{"children":"To validate if my initial assumptions are correct, and a smaller image equals\nfaster init times, I've set up the following test. I've created three Lambda\ncompatible docker images that contain the same function code:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":["The first one is built using the AWS base image\n",["$","code",null,{"children":"public.ecr.aws/lambda/nodejs:20.2024.11.06.17"}],":","\n",["$","pre",null,{"className":"language-dockerfile","children":["$","code",null,{"className":"language-dockerfile code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token instruction","children":[["$","span",null,{"className":"token keyword","children":"FROM"}]," public.ecr.aws/lambda/nodejs:20.2024.11.06.17"]}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token instruction","children":[["$","span",null,{"className":"token keyword","children":"COPY"}]," handler.js ",["$","span",null,{"className":"token variable","children":"$${LAMBDA_TASK_ROOT}"}]]}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token instruction","children":[["$","span",null,{"className":"token keyword","children":"CMD"}]," [ ",["$","span",null,{"className":"token string","children":"\"handler.handler\""}]," ]"]}],"\n"]}]]}]}],"\n"]}],"\n",["$","li",null,{"children":["The second is built using the nix derivation described above, but with ",["$","code",null,{"children":"Intl"}],"\nenabled"]}],"\n",["$","li",null,{"children":["The third image is built using the nix derivation described above, but with\n",["$","code",null,{"children":"Intl"}]," disabled and glibc locales removed."]}],"\n"]}],"\n",["$","p",null,{"children":"The handler that is used in both images is the same as described above. To\nmeasure the init times of both Lambda functions, the following test is performed\nfor each image:"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":"The image is pushed to ECR"}],"\n",["$","li",null,{"children":"A new Lambda function using the image is created"}],"\n",["$","li",null,{"children":"The function is invoked once using the AWS CLI. The init times as reported by\nAWS are logged."}],"\n",["$","li",null,{"children":"The function is invoked in parallel up to the parallelization limit of the\naccount. The init times as reported by AWS are logged."}],"\n",["$","li",null,{"children":"A new version of the Lambda function is created using the CLI. This forces a\nnew cold start upon the next invocation."}],"\n",["$","li",null,{"children":"Steps 3-5 are repeated until the Lambda has been invoked a total of 10000\ntimes."}],"\n"]}],"\n",["$","p",null,{"children":"Step 3 is necessary because the init times of the very first Lambda call after a\nnew deployment can vary wildly from the init times of subsequent calls (I've\nseen times of up to five seconds independent of the image). As I don't want to\noptimize the very first cold start after an update, but scale out events, I will\nignore these init times."}],"\n",["$","h2",null,{"id":"results","children":"Results"}],"\n",["$","p",null,{"children":"A total of 10000 Lambda invocations were performed for each docker image using\nthe test setup described above. Of these, 9000 were cold starts with an init\ntime being reported by Lambda. The following chart shows the distribution of\nthese init times, binned to buckets of 10ms size:"}],"\n",["$","$L17",null,{}],"\n",["$","p",null,{"children":"The number you see in the chart above don't quite add up to 9000 measurements\nper image, as depending on the behaviour of the Lambda scheduler and the timing\nof the invocations, some request were not routed to new workers but instead\nprocessed by existing ones."}],"\n",["$","p",null,{"children":"By computing a few performance indicators, we can quantify the performance gains\nof our nix-based image even better:"}],"\n",["$","div",null,{"className":"relative w-full overflow-auto","children":["$","table",null,{"ref":"$undefined","className":"w-full caption-bottom text-sm","children":[["$","caption",null,{"ref":"$undefined","className":"mt-4 text-sm text-muted-foreground","children":"A comparison of a Lambda init time performance indicators. Values are rounded to the nearest integer."}],["$","thead",null,{"ref":"$undefined","className":"[&_tr]:border-b","children":["$","tr",null,{"ref":"$undefined","className":"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted","children":[["$","th",null,{"ref":"$undefined","className":"h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]"}],["$","th",null,{"ref":"$undefined","className":"h-10 px-2 align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"AWS Base Image"}],["$","th",null,{"ref":"$undefined","className":"h-10 px-2 align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"Wit Intl"}],["$","th",null,{"ref":"$undefined","className":"h-10 px-2 align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-left","children":"Î"}],["$","th",null,{"ref":"$undefined","className":"h-10 px-2 align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"Without Intl"}],["$","th",null,{"ref":"$undefined","className":"h-10 px-2 align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-left","children":"Î"}]]}]}],["$","tbody",null,{"ref":"$undefined","className":"[&_tr:last-child]:border-0","children":[["$","tr",null,{"ref":"$undefined","className":"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted","children":[["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] font-medium","children":"Mean"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"246 ms"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"204 ms"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-left text-green-500","children":"(-17,07%)"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"196 ms"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-left text-green-500","children":"(-20,32%)"}]]}],["$","tr",null,{"ref":"$undefined","className":"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted","children":[["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] font-medium","children":"Median"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"236 ms"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"191 ms"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-left text-green-500","children":"(-19,06%)"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"180 ms"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-left text-green-500","children":"(-23,72%)"}]]}],["$","tr",null,{"ref":"$undefined","className":"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted","children":[["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] font-medium","children":"Standard Deviation"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"41 ms"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"51 ms"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-red-500","children":"(+24,39%)"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-right","children":"52 ms"}],["$","td",null,{"ref":"$undefined","className":"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px] text-red-500","children":"(+26,82%)"}]]}]]}]]}]}],"\n",["$","p",null,{"children":"The mean and median init times of our nix-based image are significantly lower\ncompared to the AWS base image. Curiously, the standard deviation of the init\ntimes is worse than the AWS base image. This phenomenon might just be caused by\nblocking communication with the overarching service or differences in extension\ninit times, but I am not sure at the moment."}],"\n",["$","h2",null,{"id":"outlook","children":"Outlook"}],"\n",["$","p",null,{"children":"In this article, I've used nix to drastically reduce the image size of a Docker\nimage that can be deployed to AWS Lambda, which cuts down the init times of this\nfunction."}],"\n",["$","p",null,{"children":"The code that I am executing in the Lambda function is (intentionally) very\nsimple to keep the focus on the impact of the execution environment. The next\nstep would be to test this image with a real-world application to check whether\nthe performance and size improvements can be translated to a full, usable\napplication."}],"\n",["$","p",null,{"children":"As I am focusing on Node.js only, it would be interesting to look at other\n(interpreted) languages like Python or Ruby to see if similar improvements can\nbe made."}],"\n",["$","p",null,{"children":["If one wanted to reduce the size of the existing derivation even further, there\nare a few avenues that could be explored. For example, one could try to replace\nall usages of glibc with the much smaller ",["$","a",null,{"href":"https://musl.libc.org/","children":"musl"}],". This\nwould probably require a lot of work, as musl is not a drop-in replacement for\nglibc, but one could start by looking at how the needed applications are built\nin alpine Linux, which uses musl as its libc implementation."]}],"\n",["$","h2",null,{"id":"sourcecode","children":"Sourcecode"}],"\n",["$","p",null,{"children":["You can find the nix derivation to build the images that I've tested, as well as\nall intermediate images that I've described throughout this article,\n",["$","a",null,{"href":"https://github.com/Staff-d/nix-lambda-node-runtime","children":"on GitHub"}],"."]}],"\n",["$","h2",null,{"id":"about-the-header-image","children":"About the header image"}],"\n",["$","p",null,{"children":"Created with OpenAIs GPT-4o on 2024-11-13. Prompt:"}],"\n",["$","blockquote",null,{"children":["\n",["$","p",null,{"children":"A comic-style illustration of a large, majestic whale flying through the sky,\nbreaking through fluffy clouds as it ascends toward a bright, radiant sun. The\nwhale is depicted in mid-air, surrounded by scattered clouds that part as it\nmoves, leaving a dynamic trail. The sunlight shines through, casting a warm\ngolden glow over the scene. The background sky transitions from deep blue near\nthe clouds to bright yellow-orange near the sun. High-energy motion lines and\nbold colors emphasize the whale's powerful movement, capturing a sense of\nwonder and freedom."}],"\n"]}]]
16:["$","section",null,{"className":"w-full py-12 md:py-24 lg:py-32 bg-gray-100 dark:bg-gray-800","children":["$","div",null,{"className":"container px-4 md:px-6 mx-auto","children":[["$","h2",null,{"className":"text-3xl font-bold tracking-tighter sm:text-5xl text-center mb-4 md:mb-6","children":"More posts like this one"}],["$","div",null,{"className":"grid gap-6 md:grid-cols-2 lg:grid-cols-3","children":[["$","div","nodejs-native-ts-benchmark",{"ref":"$undefined","className":"rounded-xl border bg-card text-card-foreground shadow flex flex-col justify-between","children":[["$","div",null,{"ref":"$undefined","className":"flex flex-col space-y-1.5 p-6","children":[["$","h3",null,{"ref":"$undefined","className":"font-semibold leading-none tracking-tight","children":["$","$L4",null,{"href":"/posts/nodejs-native-ts-benchmark","children":"A look at native TypeScript performance"}]}],["$","div",null,{"className":"flex items-center space-x-1 text-sm text-gray-500","children":[["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":24,"height":24,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-calendar h-4 w-4","children":[["$","path","1cmpym",{"d":"M8 2v4"}],["$","path","4m81vk",{"d":"M16 2v4"}],["$","rect","1hopcy",{"width":"18","height":"18","x":"3","y":"4","rx":"2"}],["$","path","8toen8",{"d":"M3 10h18"}],"$undefined"]}],["$","time",null,{"dateTime":"2025-02-24T14:32:53.120Z","children":"Feb 24, 2025, 3:32 PM"}]]}]]}],["$","div",null,{"ref":"$undefined","className":"p-6 pt-0","children":["$","p",null,{"children":"Node.js 23.6.0 dropped the experimental flag for native TypeScript support. Let's see how it performs when running TS natively."}]}],["$","div",null,{"ref":"$undefined","className":"items-center p-6 pt-0 flex justify-between","children":[["$","p",null,{"className":"text-sm text-gray-500","children":["By ","Sebastian Staffa"]}],["$","$L4",null,{"href":"/posts/nodejs-native-ts-benchmark","children":["$","button",null,{"className":"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 text-primary underline-offset-4 hover:underline h-9 px-4 py-2","ref":"$undefined","children":["Read More",["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":24,"height":24,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-chevron-right ml-2 h-4 w-4","children":[["$","path","mthhwq",{"d":"m9 18 6-6-6-6"}],"$undefined"]}]]}]}]]}]]}],["$","div","note-on-nixos-handeling-feedback",{"ref":"$undefined","className":"rounded-xl border bg-card text-card-foreground shadow flex flex-col justify-between","children":[["$","div",null,{"ref":"$undefined","className":"flex flex-col space-y-1.5 p-6","children":[["$","h3",null,{"ref":"$undefined","className":"font-semibold leading-none tracking-tight","children":["$","$L4",null,{"href":"/posts/note-on-nixos-handeling-feedback","children":"Note: NixOS Feedback Handling"}]}],["$","div",null,{"className":"flex items-center space-x-1 text-sm text-gray-500","children":[["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":24,"height":24,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-calendar h-4 w-4","children":[["$","path","1cmpym",{"d":"M8 2v4"}],["$","path","4m81vk",{"d":"M16 2v4"}],["$","rect","1hopcy",{"width":"18","height":"18","x":"3","y":"4","rx":"2"}],["$","path","8toen8",{"d":"M3 10h18"}],"$undefined"]}],["$","time",null,{"dateTime":"2025-01-13T13:26:51.295Z","children":"Jan 13, 2025, 2:26 PM"}]]}]]}],["$","div",null,{"ref":"$undefined","className":"p-6 pt-0","children":["$","p",null,{"children":"A quick, positive example on how a project can handle critical feedback"}]}],["$","div",null,{"ref":"$undefined","className":"items-center p-6 pt-0 flex justify-between","children":[["$","p",null,{"className":"text-sm text-gray-500","children":["By ","Sebastian Staffa"]}],["$","$L4",null,{"href":"/posts/note-on-nixos-handeling-feedback","children":["$","button",null,{"className":"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 text-primary underline-offset-4 hover:underline h-9 px-4 py-2","ref":"$undefined","children":["Read More",["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":24,"height":24,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-chevron-right ml-2 h-4 w-4","children":[["$","path","mthhwq",{"d":"m9 18 6-6-6-6"}],"$undefined"]}]]}]}]]}]]}],["$","div","mqtt-for-webdevs",{"ref":"$undefined","className":"rounded-xl border bg-card text-card-foreground shadow flex flex-col justify-between","children":[["$","div",null,{"ref":"$undefined","className":"flex flex-col space-y-1.5 p-6","children":[["$","h3",null,{"ref":"$undefined","className":"font-semibold leading-none tracking-tight","children":["$","$L4",null,{"href":"/posts/mqtt-for-webdevs","children":"MQTT For Web Developers"}]}],["$","div",null,{"className":"flex items-center space-x-1 text-sm text-gray-500","children":[["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":24,"height":24,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-calendar h-4 w-4","children":[["$","path","1cmpym",{"d":"M8 2v4"}],["$","path","4m81vk",{"d":"M16 2v4"}],["$","rect","1hopcy",{"width":"18","height":"18","x":"3","y":"4","rx":"2"}],["$","path","8toen8",{"d":"M3 10h18"}],"$undefined"]}],["$","time",null,{"dateTime":"2024-11-20T16:13:52.889Z","children":"Nov 20, 2024, 5:13 PM"}]]}]]}],["$","div",null,{"ref":"$undefined","className":"p-6 pt-0","children":["$","p",null,{"children":"MQTT is a protocol that is typically used in an IoT context. In this article, we'll explore how we could use its capabilities in a traditional web application to stream messages in real-time."}]}],["$","div",null,{"ref":"$undefined","className":"items-center p-6 pt-0 flex justify-between","children":[["$","p",null,{"className":"text-sm text-gray-500","children":["By ","Sebastian Staffa"]}],["$","$L4",null,{"href":"/posts/mqtt-for-webdevs","children":["$","button",null,{"className":"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 text-primary underline-offset-4 hover:underline h-9 px-4 py-2","ref":"$undefined","children":["Read More",["$","svg",null,{"ref":"$undefined","xmlns":"http://www.w3.org/2000/svg","width":24,"height":24,"viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":2,"strokeLinecap":"round","strokeLinejoin":"round","className":"lucide lucide-chevron-right ml-2 h-4 w-4","children":[["$","path","mthhwq",{"d":"m9 18 6-6-6-6"}],"$undefined"]}]]}]}]]}]]}]]}]]}]}]
e:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
c:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Improving Median Lambda Init Times By 23%"}],["$","meta","2",{"name":"description","content":"In today's post we are improving the cold start times of a Node.js Lambda function by building our own runtime image using Nix."}]]
a:null
